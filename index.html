<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Pro Practice Metronome</title>
	<style>
		body {
			margin: 0;
			background: #0e0e0e;
			color: #eee;
			font-family: system-ui, -apple-system, sans-serif;
		}

		button {
			cursor: pointer;
			background: #333;
			color: white;
			border: 1px solid #444;
			padding: 12px;
			border-radius: 8px;
			transition: 0.2s;
			font-weight: bold;
		}

		button:hover {
			background: #444;
			border-color: #666;
		}

		input {
			background: #222;
			color: #fff;
			border: 1px solid #444;
			padding: 6px;
			border-radius: 4px;
		}

		.practice {
			border: 1px solid #333;
			padding: 15px;
			margin: 15px;
			border-radius: 12px;
			background: #151515;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
		}

		.met {
			border-left: 4px solid #007bff;
			padding: 10px;
			margin: 10px 0 10px 15px;
			background: #1c1c1c;
			border-radius: 0 8px 8px 0;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		#player {
			display: none;
			height: 100vh;
			justify-content: center;
			align-items: center;
			flex-direction: column;
			text-align: center;
		}

		#bpm-display {
			font-size: 110px;
			font-weight: 800;
			margin: 5px 0;
			color: #007bff;
			font-variant-numeric: tabular-nums;
			line-height: 1;
		}

		.big-controls {
			display: flex;
			gap: 25px;
			margin: 25px;
		}

		.big-controls button {
			font-size: 40px;
			width: 90px;
			height: 90px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			border: 2px solid #444;
		}

		.big-controls button:active {
			transform: scale(0.95);
			background: #555;
		}

		#stop {
			background: #800;
			border-color: #a00;
			padding: 15px 60px;
			font-size: 1.1rem;
			margin-top: 40px;
			text-transform: uppercase;
			letter-spacing: 2px;
		}

		#stop:hover {
			background: #b00;
		}

		.header {
			padding: 20px;
			border-bottom: 1px solid #333;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		#label {
			font-size: 1.5rem;
			letter-spacing: 1px;
			color: #aaa;
			margin-bottom: 10px;
		}

		#upcoming-box {
			background: rgba(255, 255, 255, 0.05);
			padding: 15px 30px;
			border-radius: 10px;
			margin-top: 10px;
			min-width: 300px;
		}
	</style>
</head>

<body>

	<div id="builder">
		<div class="header">
			<h1>Practice Builder</h1>
			<button id="addPracticeBtn">+ Add Practice</button>
		</div>
		<div id="app"></div>
	</div>

	<div id="player">
		<div id="label">SECTION NAME</div>
		<div id="bpm-display">120</div>
		<div id="remaining" style="font-size:26px; font-weight: bold; color: #fff;">00s</div>

		<div class="big-controls">
			<button id="minus">−</button>
			<button id="plus">+</button>
		</div>

		<div id="upcoming-box">
			<div style="font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 5px;">Coming Up Next</div>
			<div id="upcoming-details" style="font-size: 18px; color: #ccc;">--</div>
		</div>

		<button id="stop">STOP (ESC)</button>
	</div>

	<script>
		/* =====================
   STATE & AUDIO
===================== */
		let practices = JSON.parse(localStorage.getItem("practices") || "[]");
		const save = () => localStorage.setItem("practices", JSON.stringify(practices));

		let audioCtx = null;
		let nextTickTime = 0;
		let schedulerInterval = null;
		let sectionTimeout = null;
		let countdownInterval = null;

		let currentBPM = 120;
		let activePractice = null;
		let activeMetIndex = -1;
		let beatCounter = 0;

		function initAudio() {
			if (!audioCtx) audioCtx = new(window.AudioContext || window.webkitAudioContext)();
			if (audioCtx.state === 'suspended') audioCtx.resume();
		}

		function playClick(time, accented) {
			const osc = audioCtx.createOscillator();
			const gain = audioCtx.createGain();
			osc.frequency.setValueAtTime(accented ? 1600 : 900, time);
			gain.gain.setValueAtTime(0.3, time);
			gain.gain.exponentialRampToValueAtTime(0.001, time + 0.04);
			osc.connect(gain);
			gain.connect(audioCtx.destination);
			osc.start(time);
			osc.stop(time + 0.05);
		}

		function scheduler() {
			while (nextTickTime < audioCtx.currentTime + 0.1) {
				playClick(nextTickTime, beatCounter % 4 === 0);
				nextTickTime += 60 / currentBPM;
				beatCounter++;
			}
		}

		/* =====================
		   ENGINE
		===================== */
		function startPractice(practice) {
			initAudio();
			activePractice = practice;
			document.getElementById("builder").style.display = "none";
			document.getElementById("player").style.display = "flex";
			runSection(0);
		}

		function runSection(index) {
			if (index >= activePractice.metronomes.length) {
				if (activePractice.loop) return runSection(0);
				return stopEverything();
			}

			activeMetIndex = index;
			const met = activePractice.metronomes[index];

			currentBPM = met.startBPM;
			updateBPMDisplay();

			document.getElementById("label").textContent = met.name.toUpperCase();

			// Format Upcoming Mention
			const next = activePractice.metronomes[index + 1];
			const upcomingEl = document.getElementById("upcoming-details");
			if (next) {
				upcomingEl.innerHTML = `<strong>${next.name}</strong> • ${next.startBPM} BPM • ${next.duration}s`;
			} else if (activePractice.loop) {
				const first = activePractice.metronomes[0];
				upcomingEl.innerHTML = `<span style="color:#555">Looping to:</span> ${first.name} (${first.startBPM} BPM)`;
			} else {
				upcomingEl.textContent = "Finish Line";
			}

			beatCounter = 0;
			nextTickTime = audioCtx.currentTime;

			if (!schedulerInterval) schedulerInterval = setInterval(scheduler, 25);

			let timeLeft = met.duration;
			document.getElementById("remaining").textContent = `${timeLeft}s`;
			clearInterval(countdownInterval);
			countdownInterval = setInterval(() => {
				timeLeft--;
				document.getElementById("remaining").textContent = `${Math.max(0, timeLeft)}s`;
				if (timeLeft <= 3 && timeLeft > 0) {
					document.getElementById("remaining").style.color = "#ff4444"; // Warning colors
				} else {
					document.getElementById("remaining").style.color = "#fff";
				}
			}, 1000);

			clearTimeout(sectionTimeout);
			sectionTimeout = setTimeout(() => runSection(index + 1), met.duration * 1000);
		}

		function updateBPMDisplay() {
			document.getElementById("bpm-display").textContent = currentBPM;
			if (activePractice && activeMetIndex !== -1) {
				activePractice.metronomes[activeMetIndex].startBPM = currentBPM;
				save();
			}
		}

		function stopEverything() {
			clearInterval(schedulerInterval);
			clearInterval(countdownInterval);
			clearTimeout(sectionTimeout);
			schedulerInterval = null;
			document.getElementById("builder").style.display = "block";
			document.getElementById("player").style.display = "none";
			render();
		}

		/* =====================
		   UI BUILDER
		===================== */
		function render() {
			const app = document.getElementById("app");
			app.innerHTML = "";
			practices.forEach((p, pIdx) => {
				const card = document.createElement("div");
				card.className = "practice";
				card.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <input type="text" value="${p.name}" onchange="practices[${pIdx}].name=this.value; save();" style="font-size:1.2rem; font-weight:bold; border:none; background:transparent; width: 60%;">
        <div style="display:flex; align-items:center; gap:10px;">
          <label style="font-size:12px; color:#888;">LOOP <input type="checkbox" ${p.loop ? 'checked' : ''} onchange="practices[${pIdx}].loop=this.checked; save();"></label>
          <button onclick="practices.splice(${pIdx},1); save(); render();" style="background:#311; border-color:#522; padding:5px 10px;">✕</button>
        </div>
      </div>
    `;

				p.metronomes.forEach((m, mIdx) => {
					const mDiv = document.createElement("div");
					mDiv.className = "met";
					mDiv.innerHTML = `
        <input type="text" value="${m.name}" placeholder="Section Name" onchange="practices[${pIdx}].metronomes[${mIdx}].name=this.value; save();" style="flex:2">
        <input type="number" value="${m.startBPM}" style="width:55px" onchange="practices[${pIdx}].metronomes[${mIdx}].startBPM=parseInt(this.value); save();"> <span style="font-size:10px; color:#666">BPM</span>
        <input type="number" value="${m.duration}" style="width:55px" onchange="practices[${pIdx}].metronomes[${mIdx}].duration=parseInt(this.value); save();"> <span style="font-size:10px; color:#666">SEC</span>
        <button onclick="practices[${pIdx}].metronomes.splice(${mIdx},1); save(); render();" style="padding:4px 8px; border:none; background:transparent; color:#666;">✕</button>
      `;
					card.appendChild(mDiv);
				});

				const footer = document.createElement("div");
				footer.style.cssText = "display:flex; gap:10px; margin-top:15px;";

				const addM = document.createElement("button");
				addM.textContent = "+ ADD SECTION";
				addM.style.flex = "1";
				addM.onclick = () => {
					p.metronomes.push({
						name: "New Section",
						startBPM: 120,
						duration: 30
					});
					save();
					render();
				};

				const playBtn = document.createElement("button");
				playBtn.textContent = "▶ START PRACTICE";
				playBtn.style.flex = "2";
				playBtn.style.background = "#0056b3";
				playBtn.onclick = () => startPractice(p);

				footer.append(addM, playBtn);
				card.appendChild(footer);
				app.appendChild(card);
			});
		}

		/* =====================
		   INTERACTION
		===================== */
		const changeBPM = (delta) => {
			currentBPM = Math.max(20, Math.min(300, currentBPM + delta));
			updateBPMDisplay();
		};

		document.getElementById("plus").onclick = () => changeBPM(1);
		document.getElementById("minus").onclick = () => changeBPM(-1);
		document.getElementById("stop").onclick = stopEverything;

		document.getElementById("addPracticeBtn").onclick = () => {
			practices.push({
				name: "New Routine",
				loop: false,
				metronomes: [{
					name: "Warmup",
					startBPM: 100,
					duration: 60
				}]
			});
			save();
			render();
		};

		// Keyboard Support
		window.addEventListener('keydown', (e) => {
			if (document.getElementById("player").style.display === "flex") {
				if (e.key === "ArrowUp") changeBPM(1);
				if (e.key === "ArrowDown") changeBPM(-1);
				if (e.key === "Escape") stopEverything();
			}
		});

		render();
	</script>
</body>

</html>