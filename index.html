<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>Pro Practice Metronome</title>
	<style>
		:root {
			--primary: #007bff;
			--bg: #0e0e0e;
			--card: #151515;
			--text: #eee;
			--container-width: 450px;
		}

		body {
			margin: 0;
			background: var(--bg);
			color: var(--text);
			font-family: system-ui, -apple-system, sans-serif;
			display: flex;
			justify-content: center;
		}

		#builder,
		#player {
			width: 100%;
			max-width: var(--container-width);
			min-height: 100vh;
			padding: 20px;
			box-sizing: border-box;
		}

		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
		}

		.practice {
			border: 1px solid #333;
			padding: 20px;
			margin-bottom: 20px;
			border-radius: 16px;
			background: var(--card);
			position: relative;
		}

		.met {
			border-left: 4px solid var(--primary);
			padding: 12px;
			margin: 12px 0;
			background: #1c1c1c;
			display: grid;
			grid-template-columns: 1fr 60px 60px 30px;
			gap: 10px;
			align-items: center;
			border-radius: 4px;
		}

		input {
			background: #222;
			color: #fff;
			border: 1px solid #444;
			padding: 10px;
			border-radius: 8px;
			font-size: 14px;
		}

		#player {
			display: none;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			gap: 25px;
		}

		#bpm-display {
			font-size: 90px;
			font-weight: 800;
			color: var(--primary);
			line-height: 1;
			margin: 10px 0;
		}

		.knob-container {
			width: 180px;
			height: 180px;
			position: relative;
			cursor: ns-resize;
			touch-action: none;
		}

		.knob {
			width: 100%;
			height: 100%;
			border-radius: 50%;
			background: radial-gradient(circle at 30% 30%, #444, #222);
			border: 5px solid #333;
			position: relative;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
		}

		.knob-indicator {
			position: absolute;
			width: 6px;
			height: 20%;
			background: var(--primary);
			left: 50%;
			top: 8%;
			transform: translateX(-50%);
			border-radius: 10px;
		}

		.dot {
			width: 18px;
			height: 18px;
			background: #222;
			border-radius: 50%;
			border: 1px solid #333;
			display: inline-block;
			margin: 0 6px;
		}

		.dot.active-accent {
			background: var(--primary);
			box-shadow: 0 0 15px var(--primary);
		}

		.dot.active-normal {
			background: #eee;
			box-shadow: 0 0 10px #eee;
		}

		.big-controls {
			display: flex;
			gap: 25px;
			align-items: center;
		}

		.btn-circle {
			width: 65px;
			height: 65px;
			border-radius: 50%;
			font-size: 24px;
			background: #222;
			color: #eee;
			border: 1px solid #444;
			cursor: pointer;
		}

		.btn-play {
			width: 85px;
			height: 85px;
			background: var(--primary);
			border: none;
			font-size: 36px;
			color: white;
		}

		.bottom-meta {
			margin-top: 10px;
			width: 100%;
		}

		.nav-btns {
			display: flex;
			justify-content: center;
			gap: 40px;
			margin-bottom: 15px;
		}

		button {
			font-family: inherit;
			transition: opacity 0.2s;
		}

		button:active {
			opacity: 0.7;
		}

		.delete-routine {
			background: none;
			border: none;
			color: #ff4444;
			cursor: pointer;
			font-size: 18px;
			opacity: 0.5;
		}

		.delete-routine:hover {
			opacity: 1;
		}
	</style>
</head>

<body>

	<div id="builder">
		<header>
			<h1>METRONOME</h1>
			<button id="addPracticeBtn" style="background: #007bff; padding: 10px 20px; border-radius: 25px; color: white; border:none; cursor:pointer; font-weight: bold;">+ NEW</button>
		</header>
		<div id="app"></div>
	</div>

	<div id="player">
		<div style="text-align: center;">
			<div id="label" style="font-weight: 800; letter-spacing: 2px; color: #666; font-size: 12px; margin-bottom: 10px;">SECTION NAME</div>
			<div class="beat-container">
				<div class="dot" id="dot-0"></div>
				<div class="dot" id="dot-1"></div>
				<div class="dot" id="dot-2"></div>
				<div class="dot" id="dot-3"></div>
			</div>
		</div>

		<div class="knob-container" id="knobContainer">
			<div class="knob" id="knob">
				<div class="knob-indicator"></div>
			</div>
		</div>

		<div style="text-align: center;">
			<div id="bpm-display">120</div>
			<div id="remaining" style="font-family: monospace; font-size: 24px; color: #888;">00s</div>
		</div>

		<div class="big-controls">
			<button id="minus" class="btn-circle">âˆ’</button>
			<button id="playPause" class="btn-circle btn-play">II</button>
			<button id="plus" class="btn-circle">+</button>
		</div>

		<div class="bottom-meta">
			<div class="nav-btns">
				<button id="prevBtn" style="background:none; border:none; color:#666; cursor:pointer; font-weight: bold;">PREV</button>
				<button id="nextBtn" style="background:none; border:none; color:#666; cursor:pointer; font-weight: bold;">NEXT</button>
			</div>
			<div id="upcoming-details" style="font-size: 13px; color: #444; text-align: center; margin-bottom: 20px;">--</div>
			<button id="stop" style="display:block; margin: 0 auto; background:none; border:none; color:#522; cursor:pointer; font-size: 12px; font-weight: bold;">EXIT ROUTINE</button>
		</div>
	</div>

	<script>
		let practices = JSON.parse(localStorage.getItem("practices") || "[]");
		const save = () => localStorage.setItem("practices", JSON.stringify(practices));

		let audioCtx, nextTickTime = 0,
			schedulerInterval, countdownInterval;
		let currentBPM = 120,
			activePractice = null,
			activeMetIndex = -1;
		let beatCounter = 0,
			isPaused = false,
			timeLeftInSection = 0;

		/* KNOB LOGIC */
		const knob = document.getElementById('knob');
		const knobContainer = document.getElementById('knobContainer');
		let isDragging = false,
			lastY = 0;

		const startDrag = (y) => {
			isDragging = true;
			lastY = y;
			initAudio();
		};
		const moveDrag = (y) => {
			if (!isDragging) return;
			adjustBPM(lastY - y);
			lastY = y;
		};

		knobContainer.onmousedown = (e) => startDrag(e.clientY);
		window.onmousemove = (e) => moveDrag(e.clientY);
		window.onmouseup = () => isDragging = false;
		knobContainer.ontouchstart = (e) => startDrag(e.touches[0].clientY);
		window.ontouchmove = (e) => moveDrag(e.touches[0].clientY);
		window.ontouchend = () => isDragging = false;

		function adjustBPM(amount) {
			currentBPM = Math.max(20, Math.min(300, currentBPM + amount));
			const rotation = ((currentBPM - 20) / (300 - 20) * 300) - 150;
			knob.style.transform = `rotate(${rotation}deg)`;
			updatePlayerUI();
		}

		function initAudio() {
			if (!audioCtx) audioCtx = new(window.AudioContext || window.webkitAudioContext)();
			if (audioCtx.state === 'suspended') audioCtx.resume();
		}

		function playClick(time, accented, currentBeat) {
			const osc = audioCtx.createOscillator();
			const gain = audioCtx.createGain();
			osc.frequency.setValueAtTime(accented ? 1600 : 900, time);
			gain.gain.setValueAtTime(0.3, time);
			gain.gain.exponentialRampToValueAtTime(0.001, time + 0.04);
			osc.connect(gain);
			gain.connect(audioCtx.destination);
			osc.start(time);
			osc.stop(time + 0.05);
			setTimeout(() => {
				if (!isPaused) lightUpDot(currentBeat);
			}, (time - audioCtx.currentTime) * 1000);
		}

		function lightUpDot(beatIndex) {
			document.querySelectorAll('.dot').forEach(d => d.className = 'dot');
			const dot = document.getElementById(`dot-${beatIndex}`);
			if (dot) {
				dot.classList.add(beatIndex === 0 ? 'active-accent' : 'active-normal');
				setTimeout(() => {
					dot.className = 'dot';
				}, 150);
			}
		}

		function scheduler() {
			if (isPaused) return;
			while (nextTickTime < audioCtx.currentTime + 0.1) {
				playClick(nextTickTime, (beatCounter % 4) === 0, beatCounter % 4);
				nextTickTime += 60 / currentBPM;
				beatCounter++;
			}
		}

		function runSection(index) {
			if (!activePractice || index >= activePractice.metronomes.length) {
				if (activePractice?.loop) return runSection(0);
				return stopEverything();
			}
			if (index < 0) index = 0;
			activeMetIndex = index;
			const met = activePractice.metronomes[index];
			currentBPM = met.startBPM;
			timeLeftInSection = met.duration;
			adjustBPM(0);
			updatePlayerUI();
			beatCounter = 0;
			nextTickTime = audioCtx.currentTime;
			if (!schedulerInterval) schedulerInterval = setInterval(scheduler, 25);
			startCountdown();
		}

		function startCountdown() {
			clearInterval(countdownInterval);
			countdownInterval = setInterval(() => {
				if (!isPaused) {
					timeLeftInSection--;
					document.getElementById("remaining").textContent = `${Math.max(0, timeLeftInSection)}s`;
					if (timeLeftInSection <= 0) runSection(activeMetIndex + 1);
				}
			}, 1000);
		}

		function updatePlayerUI() {
			if (activeMetIndex === -1) return;
			document.getElementById("bpm-display").textContent = Math.round(currentBPM);
			document.getElementById("label").textContent = activePractice.metronomes[activeMetIndex].name.toUpperCase();
			const next = activePractice.metronomes[activeMetIndex + 1];
			document.getElementById("upcoming-details").textContent = next ? `UPCOMING: ${next.name}` : "FINAL SECTION";
			activePractice.metronomes[activeMetIndex].startBPM = currentBPM;
			save();
		}

		function stopEverything() {
			isPaused = false;
			clearInterval(schedulerInterval);
			clearInterval(countdownInterval);
			schedulerInterval = null;
			document.getElementById("builder").style.display = "block";
			document.getElementById("player").style.display = "none";
			render();
		}

		function render() {
			const app = document.getElementById("app");
			app.innerHTML = "";
			practices.forEach((p, pIdx) => {
				const card = document.createElement("div");
				card.className = "practice";
				card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <input type="text" value="${p.name}" onchange="practices[${pIdx}].name=this.value; save();" style="font-weight:bold; border:none; background:transparent; font-size:1.2rem; color:#007bff; width: 50%;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <label style="font-size:10px; color:#666;">LOOP <input type="checkbox" ${p.loop ? 'checked' : ''} onchange="practices[${pIdx}].loop=this.checked; save();" style="width:auto; vertical-align:middle;"></label>
                    <button class="delete-routine" onclick="if(confirm('Delete entire routine?')){practices.splice(${pIdx},1); save(); render();}">ðŸ—‘</button>
                </div>
            </div>
        `;
				p.metronomes.forEach((m, mIdx) => {
					const mDiv = document.createElement("div");
					mDiv.className = "met";
					mDiv.innerHTML = `
                <input type="text" value="${m.name}" onchange="practices[${pIdx}].metronomes[${mIdx}].name=this.value; save();">
                <input type="number" value="${m.startBPM}" onchange="practices[${pIdx}].metronomes[${mIdx}].startBPM=parseInt(this.value); save();">
                <input type="number" value="${m.duration}" onchange="practices[${pIdx}].metronomes[${mIdx}].duration=parseInt(this.value); save();">
                <button onclick="practices[${pIdx}].metronomes.splice(${mIdx},1); save(); render();" style="background:none; border:none; color:#555; cursor:pointer;">âœ•</button>
            `;
					card.appendChild(mDiv);
				});
				const actions = document.createElement("div");
				actions.style.display = "flex";
				actions.style.gap = "10px";
				actions.style.marginTop = "20px";
				const addBtn = document.createElement("button");
				addBtn.textContent = "+ Section";
				addBtn.style.flex = "1";
				addBtn.style.padding = "12px";
				addBtn.style.borderRadius = "8px";
				addBtn.style.background = "#222";
				addBtn.style.color = "#fff";
				addBtn.style.border = "1px solid #444";
				addBtn.style.cursor = "pointer";
				addBtn.onclick = () => {
					p.metronomes.push({
						name: "Part",
						startBPM: 120,
						duration: 60
					});
					save();
					render();
				};
				const startBtn = document.createElement("button");
				startBtn.textContent = "START â–¶";
				startBtn.style.flex = "1.5";
				startBtn.style.padding = "12px";
				startBtn.style.borderRadius = "8px";
				startBtn.style.background = "#007bff";
				startBtn.style.color = "white";
				startBtn.style.border = "none";
				startBtn.style.cursor = "pointer";
				startBtn.style.fontWeight = "bold";
				startBtn.onclick = () => {
					document.getElementById("builder").style.display = "none";
					document.getElementById("player").style.display = "flex";
					initAudio();
					activePractice = p;
					isPaused = false;
					runSection(0);
				};
				actions.append(addBtn, startBtn);
				card.appendChild(actions);
				app.appendChild(card);
			});
		}

		document.getElementById("playPause").onclick = () => {
			isPaused = !isPaused;
			document.getElementById("playPause").textContent = isPaused ? "â–¶" : "II";
		};
		document.getElementById("plus").onclick = () => adjustBPM(1);
		document.getElementById("minus").onclick = () => adjustBPM(-1);
		document.getElementById("nextBtn").onclick = () => runSection(activeMetIndex + 1);
		document.getElementById("prevBtn").onclick = () => runSection(activeMetIndex - 1);
		document.getElementById("stop").onclick = stopEverything;

		document.getElementById("addPracticeBtn").onclick = () => {
			practices.push({
				name: "New Routine",
				loop: false,
				metronomes: [{
					name: "Warmup",
					startBPM: 100,
					duration: 60
				}]
			});
			save();
			render();
		};

		render();
	</script>
</body>

</html>